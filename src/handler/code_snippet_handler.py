from logging import getLogger, Logger
from lzstring import LZString
import json
import re

class CodeSnippetHandler:
    lz: LZString
    logger: Logger
    def __init__(self, **kwargs):
        self.logger = getLogger(self.__class__.__name__)
        self.lz = LZString()

    def process_snippet(self, code):
        """
        处理代码片段
        """
        snippet = re.match(r'```([^\n]*)\n(.*)\n```', code, re.S)
        if not snippet: return False, None
        # 确定代码语言
        lang = snippet[1].strip()
        if not lang: return False, None
        for key in lang_ext_dict:
            if re.match(key, lang):
                lang = key
                break
        if lang != key: return False, None
        filename = 'index' if re.match(r'\.(html|js|css|jsp|php|cs)', lang_ext_dict[lang]) else 'main'
        filename += lang_ext_dict[lang]
        data = {
            'files': {
                filename: {
                    'content': snippet[2],
                },
            },
        }
        data = self.lz.compressToBase64(json.dumps(data, ensure_ascii=False))
        self.logger.info('压缩代码片段完成，语言：%s', lang)
        return True, data

    def extract_snippet(self, data):
        """
        从压缩字符串中解压出代码片段
        """
        if not data: return
        return self.lz.decompressFromBase64(data)

    def get_debug_html(self, data):
        """
        返回指定 data 的中转至代码调试工具页面的响应
        """
        return """\
<html><head><title>代码调试</title></head><body><p align='center'><form id='debug' action='https://codesandbox.io/api/v1/sandboxes/define' method='POST'>
  <input type='hidden' name='parameters' value='{}' />
</form><h2 id='notice'></h2></p>
<script type='text/javascript'>\
    if(navigator.userAgent.toLowerCase().indexOf('micromessenger')>-1)\
        document.querySelector('h2').innerText = '请点击右上角“…”→“在浏览器打开”即可调试！';\
    else\
        document.querySelector('form#debug').submit();\
</script></body></html>\
""".format(data)

lang_ext_dict = {
    r'1c\-enterprise': '.bsl',
    r'4d': '.4dm',
    r'abap': '.abap',
    r'abnf': '.abnf',
    r'ags\-script|ags': '.asc',
    r'ampl': '.ampl',
    r'antlr': '.g4',
    r'api\-blueprint': '.apib',
    r'apl': '.apl',
    r'asn.1': '.asn',
    r'asp|aspx|aspx\-vb': '.asp',
    r'ats|ats2': '.dats',
    r'actionscript|actionscript3|as3': '.as',
    r'ada|ada95|ada2005': '.adb',
    r'adobe\-font\-metrics|acfm|amfm': '.afm',
    r'agda': '.agda',
    r'alloy': '.als',
    r'alpine\-abuild|abuild|apkbuild': 'APKBUILD',
    r'altium\-designer|altium': '.OutJob',
    r'angelscript': '.as',
    r'ant\-build\-system': 'ant.xml',
    r'apacheconf|aconf|apache': '.apacheconf',
    r'apex': '.cls',
    r'apollo\-guidance\-computer': '.agc',
    r'applescript|osascript': '.applescript',
    r'arc': '.arc',
    r'asciidoc': '.asciidoc',
    r'aspectj': '.aj',
    r'assembly|asm|nasm': '.asm',
    r'asymptote': '.asy',
    r'augeas': '.aug',
    r'autohotkey|ahk': '.ahk',
    r'autoit|au3|AutoIt3|AutoItScript': '.au3',
    r'awk': '.awk',
    r'ballerina': '.bal',
    r'batchfile|bat|batch|dosbatch|winbatch': '.bat',
    r'befunge': '.befunge',
    r'bibtex': '.bib',
    r'bison': '.bison',
    r'bitbake': '.bb',
    r'blade': '.blade',
    r'blitzbasic|b3d|blitz3d|blitzplus|bplus': '.bb',
    r'blitzmax|bmax': '.bmx',
    r'bluespec': '.bsv',
    r'boo': '.boo',
    r'brainfuck': '.b',
    r'brightscript': '.brs',
    r'c': '.c',
    r'c#|csharp': '.cs',
    r'c\+\+|cpp': '.cpp',
    r'c\-objdump': '.c\-objdump',
    r'c2hs\-haskell|c2hs': '.chs',
    r'clips': '.clp',
    r'cmake': '.cmake',
    r'cobol': '.cob',
    r'collada': '.dae',
    r'cson': '.cson',
    r'css': '.css',
    r'csv': '.csv',
    r'cweb': '.w',
    r'cabal\-config|Cabal': '.cabal',
    r'cap’n\-proto': '.capnp',
    r'cartocss|Carto': '.mss',
    r'ceylon': '.ceylon',
    r'chapel|chpl': '.chpl',
    r'charity': '.ch',
    r'chuck': '.ck',
    r'cirru': '.cirru',
    r'clarion': '.clw',
    r'clean': '.icl',
    r'click': '.click',
    r'clojure': '.clj',
    r'closure\-templates|soy': '.soy',
    r'cloud\-firestore\-security\-rules': 'firestore.rules',
    r'conll\-u|CoNLL|CoNLL\-X': '.conllu',
    r'codeql|ql': '.ql',
    r'coffeescript|coffee|coffee\-script': '.coffee',
    r'coldfusion|cfm|cfml': '.cfm',
    r'coldfusion\-cfc|cfc': '.cfc',
    r'common\-lisp|lisp': '.lisp',
    r'common\-workflow\-language|cwl': '.cwl',
    r'component\-pascal|delphi|objectpascal': '.cp',
    r'cool': '.cl',
    r'coq': '.coq',
    r'cpp\-objdump|c\+\+\-objdump': '.cppobjdump',
    r'creole': '.creole',
    r'crystal': '.cr',
    r'csound|csound\-orc': '.orc',
    r'csound\-document|csound\-csd': '.csd',
    r'csound\-score|csound\-sco': '.sco',
    r'cuda': '.cu',
    r'cycript': '.cy',
    r'cython|pyrex': '.pyx',
    r'd': '.d',
    r'd\-objdump': '.d\-objdump',
    r'digital\-command\-language|dcl': '.com',
    r'dm|byond': '.dm',
    r'dns\-zone': '.zone',
    r'dtrace|dtrace\-script': '.d',
    r'dafny': '.dfy',
    r'darcs\-patch|dpatch': '.darcspatch',
    r'dart': '.dart',
    r'dataweave': '.dwl',
    r'dhall': '.dhall',
    r'diff|udiff': '.diff',
    r'directx\-3d\-file': '.x',
    r'dockerfile': 'Dockerfile',
    r'dogescript': '.djs',
    r'dylan': '.dylan',
    r'e': '.E',
    r'ebnf': '.ebnf',
    r'ecl': '.ecl',
    r'eclipse': '.ecl',
    r'ejs': '.ejs',
    r'eml': '.eml',
    r'eq': '.eq',
    r'eagle': '.sch',
    r'easybuild': '.eb',
    r'ecere\-projects': '.epj',
    r'editorconfig|editor\-config': '.editorconfig',
    r'edje\-data\-collection': '.edc',
    r'eiffel': '.e',
    r'elixir': '.ex',
    r'elm': '.elm',
    r'emacs\-lisp|elisp|emacs': '.el',
    r'emberscript': '.em',
    r'erlang': '.erl',
    r'f#|fsharp': '.fs',
    r'f\*|fstar': '.fst',
    r'figlet\-font|FIGfont': '.flf',
    r'flux': '.fx',
    r'factor': '.factor',
    r'fancy': '.fy',
    r'fantom': '.fan',
    r'faust': '.dsp',
    r'filebench\-wml': '.f',
    r'filterscript': '.fs',
    r'formatted': '.for',
    r'forth': '.fth',
    r'fortran': '.f',
    r'fortran\-free\-form': '.f90',
    r'freemarker|ftl': '.ftl',
    r'frege': '.fr',
    r'futhark': '.fut',
    r'g\-code': '.g',
    r'gaml': '.gaml',
    r'gams': '.gms',
    r'gap': '.g',
    r'gcc\-machine\-description': '.md',
    r'gdb': '.gdb',
    r'gdscript': '.gd',
    r'gedcom': '.ged',
    r'glsl': '.glsl',
    r'gn': '.gn',
    r'game\-maker\-language': '.gml',
    r'genie': '.gs',
    r'genshi|xml\+genshi|xml\+kid': '.kid',
    r'gentoo\-ebuild': '.ebuild',
    r'gentoo\-eclass': '.eclass',
    r'gerber\-image|rs\-274x': '.gbr',
    r'gettext\-catalog|pot': '.po',
    r'gherkin|cucumber': '.feature',
    r'git\-attributes|gitattributes': '.gitattributes',
    r'git\-config|gitconfig|gitmodules': '.gitconfig',
    r'glyph': '.glf',
    r'glyph\-bitmap\-distribution\-format': '.bdf',
    r'gnuplot': '.gp',
    r'go|golang': '.go',
    r'golo': '.golo',
    r'gosu': '.gs',
    r'grace': '.grace',
    r'gradle': '.gradle',
    r'grammatical\-framework|gf': '.gf',
    r'graph\-modeling\-language': '.gml',
    r'graphql': '.graphql',
    r'dot': '.dot',
    r'groovy': '.groovy',
    r'groovy\-server\-pages|gsp': '.gsp',
    r'haproxy': '.cfg',
    r'hcl|terraform': '.hcl',
    r'hlsl': '.hlsl',
    r'html|xhtml': '.html',
    r'html\+django|django|html\+jinja|htmldjango': '.jinja',
    r'html\+ecr|ecr': '.ecr',
    r'html\+eex|eex': '.eex',
    r'html\+erb|erb': '.erb',
    r'html\+php': '.phtml',
    r'html\+razor|razor': '.cshtml',
    r'http': '.http',
    r'hxml': '.hxml',
    r'hack': '.hack',
    r'haml': '.haml',
    r'handlebars|hbs|htmlbars': '.handlebars',
    r'harbour': '.hb',
    r'haskell': '.hs',
    r'haxe': '.hx',
    r'hiveql': '.q',
    r'holyc': '.hc',
    r'hy|hylang': '.hy',
    r'hyphy': '.bf',
    r'idl': '.pro',
    r'igor\-pro|igor|igorpro': '.ipf',
    r'ini|dosini': '.ini',
    r'irc\-log|irc': '.irclog',
    r'idris': '.idr',
    r'ignore\-list|ignore|gitignore|git\-ignore': '.gitignore',
    r'inform\-7|i7|inform7': '.ni',
    r'inno\-setup': '.iss',
    r'io': '.io',
    r'ioke': '.ik',
    r'isabelle': '.thy',
    r'isabelle\-root': 'ROOT',
    r'j': '.ijs',
    r'jflex': '.flex',
    r'json': '.json',
    r'json\-with\-comments|jsonc': '.jsonc',
    r'json5': '.json5',
    r'jsonld': '.jsonld',
    r'jsoniq': '.jq',
    r'jsx': '.jsx',
    r'jasmin': '.j',
    r'java': '.java',
    r'java\-properties': '.properties',
    r'java\-server\-pages|jsp': '.jsp',
    r'javascript|js|node': '.js',
    r'javascript\+erb': '.js.erb',
    r'jison': '.jison',
    r'jison\-lex': '.jisonlex',
    r'jolie': '.ol',
    r'jsonnet': '.jsonnet',
    r'julia': '.jl',
    r'jupyter\-notebook': '.ipynb',
    r'krl': '.krl',
    r'kicad\-layout|pcbnew': '.kicad_pcb',
    r'kicad\-legacy\-layout': '.brd',
    r'kicad\-schematic': '.sch',
    r'kit': '.kit',
    r'kotlin': '.kt',
    r'lfe': '.lfe',
    r'llvm': '.ll',
    r'lolcode': '.lol',
    r'lsl': '.lsl',
    r'ltspice\-symbol': '.asy',
    r'labview': '.lvproj',
    r'lasso|lassoscript': '.lasso',
    r'latte': '.latte',
    r'lean': '.lean',
    r'less': '.less',
    r'lex|flex': '.l',
    r'lilypond': '.ly',
    r'limbo': '.b',
    r'linker\-script': '.ld',
    r'linux\-kernel\-module': '.mod',
    r'liquid': '.liquid',
    r'literate\-agda': '.lagda',
    r'literate\-coffeescript|litcoffee': '.litcoffee',
    r'literate\-haskell|lhaskell|lhs': '.lhs',
    r'livescript|live\-script|ls': '.ls',
    r'logos': '.xm',
    r'logtalk': '.lgt',
    r'lookml': '.lookml',
    r'loomscript': '.ls',
    r'lua': '.lua',
    r'm|mumps': '.mumps',
    r'm4': '.m4',
    r'm4sugar|autoconf': '.m4',
    r'matlab|octave': '.matlab',
    r'maxscript': '.ms',
    r'mlir': '.mlir',
    r'mql4': '.mq4',
    r'mql5': '.mq5',
    r'mtml': '.mtml',
    r'muf': '.muf',
    r'macaulay2|m2': '.m2',
    r'makefile|bsdmake|make|mf': '.mak',
    r'mako': '.mako',
    r'markdown|pandoc': '.md',
    r'marko|markojs': '.marko',
    r'mask': '.mask',
    r'mathematica|mma': '.mathematica',
    r'maven\-pom': 'pom.xml',
    r'max|max/msp|maxmsp': '.maxpat',
    r'mediawiki': '.mediawiki',
    r'mercury': '.m',
    r'meson': 'meson.build',
    r'metal': '.metal',
    r'microsoft\-developer\-studio\-project': '.dsp',
    r'minid': '.minid',
    r'mirah': '.druby',
    r'modelica': '.mo',
    r'modula\-2': '.mod',
    r'modula\-3': '.i3',
    r'module\-management\-system': '.mms',
    r'monkey': '.monkey',
    r'moocode': '.moo',
    r'moonscript': '.moon',
    r'motorola\-68k\-assembly|m68k': '.asm',
    r'muse|amusewiki': '.muse',
    r'myghty': '.myt',
    r'nasl': '.nasl',
    r'ncl': '.ncl',
    r'neon|ne\-on': '.neon',
    r'nl': '.nl',
    r'npm\-config|npmrc': '.npmrc',
    r'nsis': '.nsi',
    r'nearley': '.ne',
    r'nemerle': '.n',
    r'netlinx': '.axs',
    r'netlinx\+erb': '.axs.erb',
    r'netlogo': '.nlogo',
    r'newlisp': '.nl',
    r'nextflow': '.nf',
    r'nginx': '.nginxconf',
    r'nim': '.nim',
    r'ninja': '.ninja',
    r'nit': '.nit',
    r'nix|nixos': '.nix',
    r'nu|nush': '.nu',
    r'numpy': '.numpy',
    r'ocaml': '.ml',
    r'objdump': '.objdump',
    r'object\-data\-instance\-notation': '.odin',
    r'objectscript': '.cls',
    r'objective\-c|obj\-c|objc|objectivec': '.m',
    r'objective\-c\+\+|obj\-c\+\+|objc\+\+|objectivec\+\+': '.mm',
    r'objective\-j|obj\-j|objectivej|objj': '.j',
    r'odin|odinlang|odin\-lang': '.odin',
    r'omgrofl': '.omgrofl',
    r'opa': '.opa',
    r'opal': '.opal',
    r'open\-policy\-agent': '.rego',
    r'opencl': '.cl',
    r'openedge\-abl|progress|openedge|abl': '.p',
    r'openqasm': '.qasm',
    r'openrc\-runscript|openrc': '',
    r'openscad': '.scad',
    r'openstep\-property\-list': '.plist',
    r'opentype\-feature\-file|AFDKO': '.fea',
    r'org': '.org',
    r'ox': '.ox',
    r'oxygene': '.oxygene',
    r'oz': '.oz',
    r'p4': '.p4',
    r'php|inc': '.php',
    r'plsql': '.pls',
    r'plpgsql': '.pgsql',
    r'pov\-ray\-sdl|pov\-ray|povray': '.pov',
    r'pan': '.pan',
    r'papyrus': '.psc',
    r'parrot': '.parrot',
    r'parrot\-assembly|pasm': '.pasm',
    r'parrot\-internal\-representation|pir': '.pir',
    r'pascal': '.pas',
    r'pawn': '.pwn',
    r'pep8': '.pep',
    r'perl|cperl': '.pl',
    r'pic': '.pic',
    r'pickle': '.pkl',
    r'picolisp': '.l',
    r'piglatin': '.pig',
    r'pike': '.pike',
    r'plantuml': '.puml',
    r'pod': '.pod',
    r'pod\-6': '.pod',
    r'pogoscript': '.pogo',
    r'pony': '.pony',
    r'postcss': '.pcss',
    r'postscript|postscr': '.ps',
    r'powerbuilder': '.pbt',
    r'powershell|posh|pwsh': '.ps1',
    r'prisma': '.prisma',
    r'processing': '.pde',
    r'proguard': '.pro',
    r'prolog': '.pl',
    r'propeller\-spin': '.spin',
    r'protocol\-buffer|protobuf': '.proto',
    r'public\-key': '.asc',
    r'pug': '.jade',
    r'puppet': '.pp',
    r'pure\-data': '.pd',
    r'purebasic': '.pb',
    r'purescript': '.purs',
    r'python|python3|rusthon': '.py',
    r'python\-console|pycon': '',
    r'python\-traceback': '.pytb',
    r'qml': '.qml',
    r'qmake': '.pro',
    r'quake': 'm3makefile',
    r'r|R|Rscript|splus': '.r',
    r'raml': '.raml',
    r'rdoc': '.rdoc',
    r'realbasic': '.rbbas',
    r'rexx|arexx': '.rexx',
    r'rhtml|html\+ruby': '.rhtml',
    r'rmarkdown': '.rmd',
    r'rpc|rpcgen|oncrpc|xdr': '.x',
    r'rpm\-spec|specfile': '.spec',
    r'runoff': '.rnh',
    r'racket': '.rkt',
    r'ragel|ragel\-rb|ragel\-ruby': '.rl',
    r'raku|perl6|perl\-6': '.6pl',
    r'rascal': '.rsc',
    r'raw\-token\-data|raw': '.raw',
    r'readline\-config|inputrc|readline': '.inputrc',
    r'reason': '.re',
    r'rebol': '.reb',
    r'red|red/system': '.red',
    r'redcode': '.cw',
    r'regular\-expression|regexp|regex': '.regexp',
    r'ren’py|renpy': '.rpy',
    r'renderscript': '.rs',
    r'rich\-text\-format': '.rtf',
    r'ring': '.ring',
    r'riot': '.riot',
    r'robotframework': '.robot',
    r'roff|groff|mdoc|nroff|troff': '.roff',
    r'roff\-manpage': '.1',
    r'rouge': '.rg',
    r'ruby|jruby|macruby|rake|rb|rbx': '.rb',
    r'rust': '.rs',
    r'sas': '.sas',
    r'scss': '.scss',
    r'smt': '.smt2',
    r'sparql': '.sparql',
    r'sqf': '.sqf',
    r'sql': '.sql',
    r'sqlpl': '.sql',
    r'srecode\-template': '.srt',
    r'ssh\-config': 'ssh\-config',
    r'ston': '.ston',
    r'svg': '.svg',
    r'swig': '.i',
    r'sage': '.sage',
    r'saltstack|saltstate|salt': '.sls',
    r'sass': '.sass',
    r'scala': '.scala',
    r'scaml': '.scaml',
    r'scheme': '.scm',
    r'scilab': '.sci',
    r'self': '.self',
    r'shaderlab': '.shader',
    r'shell|sh|shell\-script|bash|zsh': '.sh',
    r'shellsession|console': '.sh\-session',
    r'shen': '.shen',
    r'sieve': '.sieve',
    r'slash': '.sl',
    r'slice': '.ice',
    r'slim': '.slim',
    r'smpl|coccinelle': '.cocci',
    r'smali': '.smali',
    r'smalltalk|squeak': '.st',
    r'smarty': '.tpl',
    r'solidity': '',
    r'sourcepawn|sourcemod': '.sp',
    r'spline\-font\-database': '.sfd',
    r'squirrel': '.nut',
    r'stan': '.stan',
    r'standard\-ml|sml': '.ML',
    r'starlark|bazel|bzl': '.bzl',
    r'stata': '.do',
    r'stylus': '.styl',
    r'subrip\-text': '.srt',
    r'sugarss': '.sss',
    r'supercollider': '.sc',
    r'svelte': '.svelte',
    r'swift': '.swift',
    r'systemverilog': '.sv',
    r'ti\-program': '.8xp',
    r'tla': '.tla',
    r'toml': '.toml',
    r'tsql': '.sql',
    r'tsx': '.tsx',
    r'txl': '.txl',
    r'tcl': '.tcl',
    r'tcsh': '.tcsh',
    r'tex|latex': '.tex',
    r'tea': '.tea',
    r'terra': '.t',
    r'texinfo': '.texinfo',
    r'text|fundamental': '.txt',
    r'textile': '.textile',
    r'thrift': '.thrift',
    r'turing': '.t',
    r'turtle': '.ttl',
    r'twig': '.twig',
    r'type\-language|tl': '.tl',
    r'typescript|ts': '.ts',
    r'unified\-parallel\-c': '.upc',
    r'unity3d\-asset': '.anim',
    r'unix\-assembly': '.s',
    r'uno': '.uno',
    r'unrealscript': '.uc',
    r'urweb|Ur/Web|Ur': '.ur',
    r'v|vlang': '.v',
    r'vba|vb6': '.bas',
    r'vbscript': '.vbs',
    r'vcl': '.vcl',
    r'vhdl': '.vhdl',
    r'vala': '.vala',
    r'verilog': '.v',
    r'vim\-snippet|SnipMate|UltiSnip|NeoSnippet': '.snip',
    r'vim\-script|vim|viml|nvim': '.vim',
    r'vbnet|vb.net': '.vb',
    r'volt': '.volt',
    r'vue': '.vue',
    r'wavefront\-material': '.mtl',
    r'wavefront\-object': '.obj',
    r'web\-ontology\-language': '.owl',
    r'webassembly|wast|wasm': '.wast',
    r'webidl': '.webidl',
    r'webvtt': '.vtt',
    r'wget\-config|wgetrc': '.wgetrc',
    r'windows\-registry\-entries': '.reg',
    r'wollok': '.wlk',
    r'world\-of\-warcraft\-addon\-data': '.toc',
    r'x\-bitmap|xbm': '.xbm',
    r'x\-font\-directory\-index': 'encodings.dir',
    r'x\-pixmap|xpm': '.xpm',
    r'x10|xten': '.x10',
    r'xc': '.xc',
    r'xcompose': '.XCompose',
    r'xml|rss|xsd|wsdl': '.xml',
    r'xml\-property\-list': '.plist',
    r'xpages': '.xsp\-config',
    r'xproc': '.xpl',
    r'xquery': '.xquery',
    r'xs': '.xs',
    r'xslt|xsl': '.xslt',
    r'xojo': '.xojo_code',
    r'xtend': '.xtend',
    r'yaml|yml': '.yml',
    r'yang': '.yang',
    r'yara': '.yar',
    r'yasnippet|snippet|yas': '.yasnippet',
    r'yacc': '.y',
    r'zap': '.zap',
    r'zil': '.zil',
    r'zeek|bro': '.zeek',
    r'zenscript': '.zs',
    r'zephir': '.zep',
    r'zig': '.zig',
    r'zimpl': '.zimpl',
    r'curl\-config|curlrc': '.curlrc',
    r'desktop': '.desktop',
    r'dircolors': '.dircolors',
    r'ec': '.ec',
    r'edn': '.edn',
    r'fish': '.fish',
    r'mirc\-script': '.mrc',
    r'mcfunction': '.mcfunction',
    r'mupad': '.mu',
    r'nanorc': '.nanorc',
    r'nesc': '.nc',
    r'ooc': '.ooc',
    r'q': '.q',
    r'restructuredtext|rst': '.rst',
    r'sed': '.sed',
    r'wdl': '.wdl',
    r'wisp': '.wisp',
    r'xbase|advpl|clipper|foxpro': '.prg'
}